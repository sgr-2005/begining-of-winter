<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ç»™å°æ€¡çš„ç«‹å†¬å¿ƒæ„</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f0f8ff;
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: relative;
      height: 100vh;
      width: 100vw;
    }
  
    .snowflake {
      position: absolute;
      color: #fff;
      font-size: clamp(8px, 2.5vw, 16px);
      top: -10px;
      user-select: none;
      pointer-events: none;
      z-index: 1;
      opacity: 0;
    }
  
    #stage1 {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100vh;
      position: relative;
      z-index: 5;
    }
    #stage2, #stage3 {
      display: none;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
  
    .btn {
      padding: 14px 28px;
      background: #1e88e5;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
      z-index: 10;
      position: relative;
    }
  
    /* --- ä»¥ä¸‹ä¸ºå¼¹çª—ã€æ°”æ³¡ç­‰æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰--- */
    .gift-modal, .gift-open-animation {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .gift-modal.active, .gift-open-animation.active {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: #fff;
      padding: 40px 50px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      transform: scale(0.8);
      transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 90%;
    }
    .modal-title { font-size: 28px; color: #1a237e; margin: 30px 0 25px; }
    .modal-desc { font-size: 20px; color: #3949ab; margin-bottom: 30px; line-height: 1.5; }
    .modal-btn {
      padding: 10px 24px;
      margin: 0 10px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
    }
    .confirm-btn { background: #2e7d32; color: white; }
    .cancel-btn { background: #c62828; color: white; }
    .gift-icon {
      font-size: 100px;
      margin-bottom: 15px;
      animation: spin 2s ease-in-out;
    }
    @keyframes spin {
      0% {transform: rotate(0deg) scale(0.5);}
      50% {transform: rotate(180deg) scale(1.2);}
      100% {transform: rotate(360deg) scale(1);}
    }
    .gift-success-text {
      font-size: 26px;
      color: #ff8f00;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(255, 143, 0, 0.3);
    }
  
    .tip-bubble {
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 9999;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
    }
    .tip-bubble.show { opacity: 1; transform: scale(1); }
    .tip-bubble.converge {
      transition: left 1.2s ease-out, top 1.2s ease-out, opacity 1.2s ease-out !important;
      opacity: 0 !important;
    }
    .final-bubble {
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      z-index: 10001;
      opacity: 0;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      transition: opacity 0.4s, transform 0.6s;
    }
    .final-bubble.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .final-bubble.hide { opacity: 0; transform: translate(-50%, -50%) scale(0); }
    .thanks-text {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      gap: 8px;
      font-weight: bold;
      color: #ff6b9d;
      text-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 10002;
    }
  </style>
</head>
<body>

<!-- èƒŒæ™¯éŸ³ä¹ -->
<audio id="backgroundMusic" src="music/dongxue.mp3" loop preload="auto" style="display:none;"></audio>

<!-- é˜¶æ®µ1ï¼šç¤¼ç‰© -->
<div id="stage1">
  <div class="snowfall" id="snow1"></div>
  <button id="openBtn" class="btn">æ‰“å¼€ç«‹å†¬ç¤¼ç‰©</button>

  <div class="gift-modal" id="giftModal">
    <div class="modal-content">
      <h2 class="modal-title">â„ï¸ ç«‹å†¬ç¤¼ç‰© â„ï¸</h2>
      <p class="modal-desc">æ‚¨æœ‰ä¸€ä»½ç«‹å†¬ç¤¼ç‰©ï¼Œç¡®å®šè¦æ‰“å¼€å—ï¼Ÿ</p>
      <button class="modal-btn confirm-btn" onclick="openGift()">ç¡®å®š</button>
      <button class="modal-btn cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>

  <div class="gift-open-animation" id="giftOpenAnimation">
    <div class="gift-icon">ğŸ</div>
    <div class="gift-success-text">ç¤¼ç‰©æ‰“å¼€æˆåŠŸï¼</div>
  </div>
</div>

<!-- é˜¶æ®µ2ï¼šçˆ±å¿ƒè·¯å¾„æ°”æ³¡ -->
<div id="stage2"></div>

<!-- é˜¶æ®µ3ï¼šå…¨å±éšæœºæ°”æ³¡ -->
<div id="stage3"></div>

<script>
// ========================
// å…¨å±€å˜é‡
// ========================
const bgMusic = document.getElementById('backgroundMusic');
const stage1 = document.getElementById('stage1');
const stage2 = document.getElementById('stage2');
const stage3 = document.getElementById('stage3');

const giftModal = document.getElementById('giftModal');
const giftOpenAnimation = document.getElementById('giftOpenAnimation');
const openBtn = document.getElementById('openBtn');

const winW = window.innerWidth;
const winH = window.innerHeight;
const canvasSize = Math.min(winW, winH);

// ========================
// å·¥å…·ï¼šåˆ›å»ºé›ªèŠ±
// ========================
function createSnowflakes(containerId, count = 40) {
  const container = typeof containerId === 'string' ? document.getElementById(containerId) : containerId;
  if (!container) return;

  container.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const snow = document.createElement('div');
    snow.className = 'snowflake';
    snow.textContent = 'â„ï¸';
    snow.style.left = `${Math.random() * 100}vw`;
    snow.style.fontSize = `${8 + Math.random() * 12}px`;
    snow.style.animationDuration = `${5 + Math.random() * 8}s`;
    snow.style.animationDelay = `${Math.random() * 5}s`;
    container.appendChild(snow);
  }

  if (!document.getElementById('snow-style')) {
    const style = document.createElement('style');
    style.id = 'snow-style';
    style.textContent = `
      @keyframes fall {
        0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
        10% { opacity: 0.9; }
        90% { opacity: 0.7; }
        100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
      }
      .snowflake { animation: fall linear infinite; }
    `;
    document.head.appendChild(style);
  }
}

// ========================
// é˜¶æ®µ1ï¼šç¤¼ç‰©é€»è¾‘
// ========================
function openModal() {
  giftModal.classList.add('active');
}
function closeModal() {
  giftModal.classList.remove('active');
}

function openGift() {
  // æ’­æ”¾éŸ³ä¹ï¼ˆç”¨æˆ·äº¤äº’åå…è®¸ï¼‰
  if (bgMusic.paused) {
    const playPromise = bgMusic.play();
    if (playPromise !== undefined) {
      playPromise.catch(e => console.warn("éŸ³ä¹æ’­æ”¾è¢«é˜»æ­¢:", e));
    }
  }

  openBtn.style.display = 'none';
  giftModal.classList.remove('active');
  setTimeout(() => {
    giftOpenAnimation.classList.add('active');
    setTimeout(() => {
      stage1.style.display = 'none';
      stage2.style.display = 'block';
      startStage2(); // å¯åŠ¨é˜¶æ®µäºŒ
    }, 2000);
  }, 300);
}

// ========================
// é˜¶æ®µ2ï¼šçˆ±å¿ƒè·¯å¾„æ°”æ³¡ï¼ˆåŸä»£ç äºŒï¼‰
// ========================
function generateRawHeartPoints(count) {
  const points = [];
  for (let i = 0; i < count; i++) {
    const t = (i / count) * 2 * Math.PI;
    const x = 16 * Math.pow(Math.sin(t), 3);
    const y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
    points.push({ x, y });
  }
  return points;
}

function normalizeHeartPoints(points) {
  let minX = Infinity, maxX = -Infinity;
  let minY = Infinity, maxY = -Infinity;
  for (const p of points) {
    minX = Math.min(minX, p.x);
    maxX = Math.max(maxX, p.x);
    minY = Math.min(minY, p.y);
    maxY = Math.max(maxY, p.y);
  }
  const width = maxX - minX;
  const height = maxY - minY;
  const maxDim = Math.max(width, height);
  return points.map(p => ({
    x: (p.x - (minX + maxX) / 2) / (maxDim / 2),
    y: (p.y - (minY + maxY) / 2) / (maxDim / 2)
  }));
}

const tipsStage2 = [
  'å°æ€¡å¤šå–çƒ­æ°´å“¦~', 'å°æ€¡è®°å¾—çœ‹å¤©æ°”é¢„æŠ¥~', 'å°æ€¡æ¯å¤©éƒ½è¦å¼€å¼€å¿ƒå¿ƒçš„~',
  'å°æ€¡å¤©å‡‰äº†å¤šç©¿ç‚¹è¡£æœ~', 'å°æ€¡è®°å¾—æ¯å¤©éƒ½è¦æƒ³æˆ‘å‘€~', 'å°æ€¡æˆ‘æ¯å¤©éƒ½åœ¨å‘€~',
  'å°æ€¡æˆ‘æƒ³ä½ å•¦~', 'å°æ€¡æ—©ç‚¹ç¡è§‰ä¸è®¸ç†¬å¤œ~', 'å°æ€¡æœŸå¾…æˆ‘ä»¬è§é¢çš„é‚£å¤©~',
  'å°æ€¡å¥½å¥½åƒé¥­å“¦~', 'å°æ€¡ç…§é¡¾å¥½è‡ªå·±~', 'å°æ€¡æƒ³æˆ‘äº†å°±å‘Šè¯‰æˆ‘~'
];

const bgColorsStage2 = ['#FFB6C1', '#87CEEB', '#90EE90', '#E6E6FA', '#FFFFE0',
  '#DDA0DD', '#FF7F50', '#FFE4C4', '#7FFFD4', '#FFE4E1',
  '#F0FFF0', '#FFF0F5', '#FDF5E6'];

const BUBBLE_ASPECT_RATIO = 140 / 60;

function createTipStage2(normX, normY, text, fromLeft = true) {
  const bubble = document.createElement('div');
  bubble.className = 'tip-bubble';
  bubble.textContent = text;
  bubble.style.backgroundColor = bgColorsStage2[Math.floor(Math.random() * bgColorsStage2.length)];

  const BUBBLE_WIDTH = canvasSize / 5;
  const BUBBLE_HEIGHT = BUBBLE_WIDTH / BUBBLE_ASPECT_RATIO;
  bubble.style.width = `${BUBBLE_WIDTH}px`;
  bubble.style.height = `${BUBBLE_HEIGHT}px`;
  const fontSize = Math.max(12, BUBBLE_HEIGHT / 4);
  bubble.style.fontSize = `${fontSize}px`;

  const canvasOffsetX = (winW - canvasSize) / 2;
  const canvasOffsetY = (winH - canvasSize) / 2;
  const safeArea = canvasSize * 0.85;
  const drawRadius = safeArea / 2;
  const drawX = canvasSize / 2 + normX * drawRadius;
  const drawY = canvasSize / 2 + normY * drawRadius;

  let finalX = canvasOffsetX + drawX - BUBBLE_WIDTH / 2;
  let finalY = canvasOffsetY + drawY - BUBBLE_HEIGHT / 2;

  const buffer = canvasSize * 0.4;
  const startX = fromLeft ? (canvasOffsetX - buffer) : (canvasOffsetX + canvasSize + buffer);
  const startY = canvasOffsetY + Math.random() * canvasSize;

  bubble.style.left = `${startX}px`;
  bubble.style.top = `${startY}px`;
  stage2.appendChild(bubble);

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      bubble.classList.add('show');
      bubble.style.left = `${finalX}px`;
      bubble.style.top = `${finalY}px`;
    });
  });

  setTimeout(() => {
    if (bubble.parentNode) {
      bubble.style.opacity = '0';
      bubble.style.transition = 'opacity 0.4s';
      setTimeout(() => bubble.remove(), 400);
    }
  }, 11000);
}

function startStage2() {
  createSnowflakes(stage2, /Android|iPhone|iPad/i.test(navigator.userAgent) ? 30 : 60);

  const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
  const POINTS_COUNT = isMobile ? 70 : 80;
  const DELAY_BETWEEN_POINTS = isMobile ? 180 : 120;
  const EXTRA_WAIT = 12500;

  const rawPoints = generateRawHeartPoints(POINTS_COUNT);
  const normalizedPoints = normalizeHeartPoints(rawPoints);

  normalizedPoints.forEach((point, index) => {
    setTimeout(() => {
      if (!stage2.isConnected) return;
      const tip = tipsStage2[Math.floor(Math.random() * tipsStage2.length)];
      const fromLeft = index % 2 === 0;
      createTipStage2(point.x, point.y, tip, fromLeft);
    }, index * DELAY_BETWEEN_POINTS);
  });

  const totalDuration = (POINTS_COUNT - 1) * DELAY_BETWEEN_POINTS + EXTRA_WAIT;
  setTimeout(() => {
    stage2.style.display = 'none';
    stage3.style.display = 'block';
    startStage3(); // å¯åŠ¨é˜¶æ®µä¸‰
  }, totalDuration);
}

// ========================
// é˜¶æ®µ3ï¼šå…¨å±éšæœºæ°”æ³¡ï¼ˆä½ çš„ä»£ç ä¸‰ï¼‰
// ========================
let isPaused = false;
const tipsStage3 = [
  'å°æ€¡å¤šå–çƒ­æ°´å“¦~', 'å°æ€¡è®°å¾—çœ‹å¤©æ°”é¢„æŠ¥~', 'å°æ€¡æ¯å¤©éƒ½è¦å¼€å¼€å¿ƒå¿ƒçš„~',
  'å°æ€¡å¤©å‡‰äº†å¤šç©¿ç‚¹è¡£æœ~', 'å°æ€¡è®°å¾—æ¯å¤©éƒ½è¦æƒ³æˆ‘å‘€~', 'å°æ€¡æˆ‘æ¯å¤©éƒ½åœ¨å‘€~',
  'å°æ€¡æˆ‘æƒ³ä½ å•¦~', 'å°æ€¡æ—©ç‚¹ç¡è§‰ä¸è®¸ç†¬å¤œ~', 'å°æ€¡æœŸå¾…æˆ‘ä»¬è§é¢çš„é‚£å¤©~',
  'å°æ€¡å¥½å¥½åƒé¥­å“¦~', 'å°æ€¡ç…§é¡¾å¥½è‡ªå·±~', 'å°æ€¡æƒ³æˆ‘äº†å°±å‘Šè¯‰æˆ‘~'
];
const bgColorsStage3 = [
  '#ffc0cb', '#87ceeb', '#90ee90', '#e6e6fa', '#ffffe0',
  '#dda0dd', '#ffa07a', '#ffe4c4', '#7fffd4', '#ffe4e1',
  '#f0fff0', '#fff0f5', '#fdf5e6'
];
let allBubblesStage3 = [];

const BUBBLE_WIDTH_S3 = canvasSize / 5;
const BUBBLE_HEIGHT_S3 = BUBBLE_WIDTH_S3 / (140 / 60);
const FONT_SIZE_S3 = Math.max(12, BUBBLE_HEIGHT_S3 / 4);

const FINAL_BUBBLE_WIDTH = canvasSize / 5;
const FINAL_BUBBLE_HEIGHT = FINAL_BUBBLE_WIDTH / (160 / 70);
const FINAL_FONT_SIZE = Math.max(14, FINAL_BUBBLE_HEIGHT / 4.4);

function createTipStage3() {
  if (isPaused || !stage3.isConnected) return;

  const bubble = document.createElement('div');
  bubble.className = 'tip-bubble';
  bubble.textContent = tipsStage3[Math.floor(Math.random() * tipsStage3.length)];
  bubble.style.backgroundColor = bgColorsStage3[Math.floor(Math.random() * bgColorsStage3.length)];

  bubble.style.width = `${BUBBLE_WIDTH_S3}px`;
  bubble.style.height = `${BUBBLE_HEIGHT_S3}px`;
  bubble.style.fontSize = `${FONT_SIZE_S3}px`;

  const finalX = Math.random() * (winW - BUBBLE_WIDTH_S3);
  const finalY = Math.random() * (winH - BUBBLE_HEIGHT_S3);
  bubble.style.left = `${finalX}px`;
  bubble.style.top = `${finalY}px`;

  stage3.appendChild(bubble);
  allBubblesStage3.push(bubble);
  setTimeout(() => bubble.classList.add('show'), 10);
}

function startStage3() {
  createSnowflakes(stage3, 80);

  // ç©ºæ ¼æš‚åœ
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      isPaused = !isPaused;
    }
  });

  let count = 0;
  const total = 400;
  const interval = setInterval(() => {
    if (count >= total || !stage3.isConnected) {
      clearInterval(interval);
      setTimeout(() => {
        const centerX = winW / 2 - BUBBLE_WIDTH_S3 / 2;
        const centerY = winH / 2 - BUBBLE_HEIGHT_S3 / 2;
        allBubblesStage3.forEach(b => {
          b.classList.add('converge');
          b.style.left = `${centerX}px`;
          b.style.top = `${centerY}px`;
        });

        setTimeout(() => {
          allBubblesStage3.forEach(b => b.remove());
          allBubblesStage3 = [];

          const finalBubble = document.createElement('div');
          finalBubble.className = 'final-bubble';
          finalBubble.textContent = 'ç«‹å†¬å¿«ä¹å‘€ï¼';
          finalBubble.style.width = `${FINAL_BUBBLE_WIDTH}px`;
          finalBubble.style.height = `${FINAL_BUBBLE_HEIGHT}px`;
          finalBubble.style.fontSize = `${FINAL_FONT_SIZE}px`;
          stage3.appendChild(finalBubble);
          setTimeout(() => finalBubble.classList.add('show'), 10);

          setTimeout(() => {
            finalBubble.classList.add('hide');
            setTimeout(() => {
              finalBubble.remove();
              const thanks = document.createElement('div');
              thanks.className = 'thanks-text';
              thanks.style.fontSize = `${Math.max(18, FINAL_FONT_SIZE * 1.2)}px`;
              thanks.innerHTML = 'æ„Ÿè°¢è§‚çœ‹'.split('').map(c => `<span>${c}</span>`).join('');
              stage3.appendChild(thanks);

              [...thanks.children].forEach((span, i) => {
                span.style.opacity = '0';
                span.style.transform = 'scale(0.5)';
                span.style.transition = 'opacity 0.4s, transform 0.4s';
                setTimeout(() => {
                  span.style.opacity = '1';
                  span.style.transform = 'scale(1)';
                }, i * 300);
              });
            }, 500);
          }, 1500);
        }, 1200);
      }, 1000);
      return;
    }
    createTipStage3();
    count++;
  }, 60);
}

// ========================
// åˆå§‹åŒ–
// ========================
document.addEventListener('DOMContentLoaded', () => {
  createSnowflakes('snow1');
  openBtn.addEventListener('click', openModal);
});
</script>

</body>
</html>